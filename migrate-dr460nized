#!/bin/bash

set -e

if [ "$1" != "true" ]; then
    [ "$(kreadconfig5 --key LookAndFeelPackage)" == "Sweetified Plasma" ] && [ "$(kreadconfig5 --key ColorScheme)" == "Sweetified" ] && [ "$(kreadconfig5 --key widgetStyle)" == "kvantum-dark" ]
    [ -f ~/.config/autostart/org.kde.latte-dock.desktop ]
    [ -x /usr/bin/latte-dock ]
else
    backup=(kwinrc kcminputrc kdeglobals plasmarc ksplashrc kscreenlockerrc)
    for i in "${backup[@]}"; do
        cp "$HOME/.config/$i" "$HOME/.config/$i.bak"
    done

    # Remove Kwin keys, this is not done by lookandfeeltool
    sed -i 's&Meta=org.kde.lattedock,/Latte,org.kde.LatteDock,activateLauncher&&g' kwinrc || true
    sed -i 's&\[ModifierOnlyShortcuts\]&&g' kwinrc || true

    # Apply the new dr460nized fastfetch preset
    sed -i 's/--load-config neofetch/--load-config dr460nized/g' ~/.config/fish/config.fish

    # Apply the global theme & restart plasmashell gracefully
    lookandfeeltool --resetLayout -a Dr460nized
    rm ~/.config/autostart/org.kde.latte-dock.desktop
    killall -SIGINT latte-dock
    systemctl --user restart plasma-plasmashell
fi
